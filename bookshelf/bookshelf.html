<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <title>Bookshelf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
	<link rel="stylesheet" href="bookshelf.css">
	
</head>

<body>
	<button id="logOut">Log Out</button>
	<div class="boeken" id="boeken">
		<h1>MY BOOKSHELF</h1>
		<input id="searchField" placeholder="search..."></input>
		<select id="genreSelectFilter" class="genreSelect">
			<option value="no filter">no filter</option>
		</select>
		<button id="addBtn">+</button>
		<br>
		<div id="booklist"></div>
	</div>

	<div class="addDiv" id="addDiv">
		<form class="addForm" id="addForm" name="addForm">
			<button id="backAddBtn">&lt-</button>
			<button id="removeBtn">-</button>
			<h3 id="h3Form"></h3>
			
			<label>title</label><br>
			<input id="titel" placeholder="titel">
			<label>author</label><br>
			<input id="author" placeholder="author"><br>
			<label>read</label><label id="lblGenre">genre</label><label id="lblScore">score</label><br>
			<input class="checkbox" type="checkbox" id="checkRead"><!--<span id="checkVisual"></span>-->
			<select id="genreSelect" class="genreSelect">
				<option value="no genre">no genre</option>
			</select>
			<input id="scoreIn" placeholder=""><span id="spanScorePrct">/5</span><br><br>
			<label>extra info</label><br>
			<textarea id="extraTxt" rows="5"></textarea><br>
			<select id="colorSelect">
				<option value="random color">random color</option>
			</select>


			<button class="form-btn dx" id="btnAddForm" >Add</button>
			<button class="form-btn dx" id="btnEditForm">Edit</button>
			<button class="form-btn dx" id="btnSaveForm">Save</button>
		</form>
	</div>

	<div class="removeDiv" id="removeDiv">
		<button id="removeBurnBtn">&times</button><div>Alert</div><br>
		<button id="burnBtn">Burn book</button>
	</div>




	<!------------------------------------------------------------------------------------------------------------------------------------------------------------------->
	<!------------------------------------------------------------------------------------------------------------------------------------------------------------------->
	<!------------------------------------------------------------------------------------------------------------------------------------------------------------------->
	
	
	
	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
		import { getDatabase, onValue, ref, set, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
		// import { getAuth } from "firebase/auth";
		import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
	  
		// Your web app's Firebase configuration
		const firebaseConfig = {
		  apiKey: "AIzaSyCwkZcev1aHD98mqbrkJKrgzIx80Ji6R2s",
		  authDomain: "boekenkast-9feaf.firebaseapp.com",
		  databaseURL: "https://boekenkast-9feaf-default-rtdb.europe-west1.firebasedatabase.app",
		  projectId: "boekenkast-9feaf",
		  storageBucket: "boekenkast-9feaf.appspot.com",
		  messagingSenderId: "1018308118328",
		  appId: "1:1018308118328:web:bc618dfbdbc065ee59e3cd"
		};
		
		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
	  
		//----------------------------------------------------------------------------------------------------------------------------------
		// firebase authentiaction
		//----------------------------------------------------------------------------------------------------------------------------------

		const decipher = salt => {
			const textToChars = text => text.split('').map(c => c.charCodeAt(0));
			const applySaltToChar = code => textToChars(salt).reduce((a,b) => a ^ b, code);
			return encoded => encoded.match(/.{1,2}/g)
			.map(hex => parseInt(hex, 16))
			.map(applySaltToChar)
			.map(charCode => String.fromCharCode(charCode))
			.join('');
		}

		// Initialize Firebase Authentication and get a reference to the service
		const auth = getAuth(app);

		var email = localStorage.getItem("user");
		var password = localStorage.getItem("pass");

		var passwordDe = "";
		if(password != null){
			const decrypt = decipher("test");
			passwordDe = decrypt(password);
		}
		signInWithEmailAndPassword(auth, email, passwordDe).then(u => {}).catch(error => {console.log("error has occured")});


		auth.onAuthStateChanged(function() {
			if(auth.currentUser != null){
				// console.log(auth.currentUser.uid);
				document.getElementById("boeken").style.display = "block";
				readBooks();
				readGenres();
				readColors();
				addSelectFilter();
			} else {
				document.getElementById("boeken").style.display = "none";
				window.open("bookshelfLogin.html","_self");
			}
		})

		document.getElementById("logOut").addEventListener('click',function() {
			auth.signOut();
			localStorage.clear();
		})


		//----------------------------------------------------------------------------------------------------------------------------------
		// functions with direct Firebasde acces
		//----------------------------------------------------------------------------------------------------------------------------------


	
	
		function writeBook(titel, author, read, genre, score, extra, color){
			const db = getDatabase();
			var key = createKey(titel, author);
			const reference = ref(db,auth.currentUser.uid + '/books/' + key);

			set(reference, {
				key: key,
				titel: titel,
				author: author,
				read: read,
				genre: genre,
				score: score,
				extra: extra,
				color: color
			});
		}

		function readBooks(){
			// console.log("reading")
			const db = getDatabase();
			const distanceRef = ref(db,auth.currentUser.uid + "/books");
			onValue(distanceRef, (snapchot) => {
				snapchot.forEach(book => {
					addToTable(book.val());
				});
			})
		}

		function changeBook(key, titel, author, read, genre, score, extra, color) {
			const db = getDatabase();
			const reference = ref(db,auth.currentUser.uid + '/books/' + key);
	
			set(reference, {
				key: key,
				titel: titel,
				author: author,
				read: read,
				genre: genre,
				score: score,
				extra: extra,
				color: color
			});

		}

		function burnBook(key) {
			const db = getDatabase();
			let reference = ref(db,auth.currentUser.uid + '/books/' + key);
			remove(reference);
		}

		function readGenres() {
			const db = getDatabase();
			const distanceRef = ref(db,"genres");
			onValue(distanceRef, (snapchot) => {
				snapchot.forEach(i => {
					var genre = i.val();
					addGenreSelect(genre);
				});
			})
		}

		function readColors() {
			const db = getDatabase();
			const distanceRef = ref(db,"colors");
			onValue(distanceRef, (snapchot) => {
				snapchot.forEach(i => {
					var color = i.val();
					addColorSelect(color);
				});
			})
		}

		function randomColor() {
			// const db = getDatabase();
			// const distanceRef = ref(db,"colors");
			// onValue(distanceRef, (snapchot) => {
			// 	snapchot.forEach(i => {
			// 		var color = i.val();
			// 		console.log(color.color);
			// 		genList(color.color);
			// 	});
			// })
			var colors = ["#000080", "black", "white", "#046307", "#7B1FA2", "#800020", "#36454F", "#FFFDD0", "#008080", "#0028ff"];
			return colors[Math.round(Math.random() * (colors.length-1))]
		}

		function filterBooksGenre(genre, term) {
			// console.log("filtering")
			const db = getDatabase();
			const distanceRef = ref(db,auth.currentUser.uid + "/books");
			onValue(distanceRef, (snapchot) => {
				snapchot.forEach(book => {
					if((book.val().genre.toLowerCase() == genre || genre == "no filter") && 
						(book.val().titel.toLowerCase().includes(term.toLowerCase()) 
						|| book.val().author.toLowerCase().includes(term.toLowerCase()) 
						||book.val().extra.toLowerCase().includes(term.toLowerCase())	
						||term == "")){
							addToTable(book.val());
					}
				});
			})
		}

		function filterBooksRead(filter, term) {
			// console.log("filtering")
			const db = getDatabase();
			const distanceRef = ref(db,auth.currentUser.uid + "/books");
			onValue(distanceRef, (snapchot) => {
				snapchot.forEach(book => {
					if((book.val().read.toString() == filter) && 
						(book.val().titel.toLowerCase().includes(term.toLowerCase()) 
						|| book.val().author.toLowerCase().includes(term.toLowerCase()) 
						||book.val().extra.toLowerCase().includes(term.toLowerCase())	
						||term == "")){
							addToTable(book.val());
					}
				});
			})
		}

		function filterBooksScore(filter, term) {
			// console.log("filtering")
			const db = getDatabase();
			const distanceRef = ref(db,auth.currentUser.uid + "/books");
			onValue(distanceRef, (snapchot) => {
				snapchot.forEach(book => {
					if((book.val().score.toString() == filter) && 
						(book.val().titel.toLowerCase().includes(term.toLowerCase()) 
						|| book.val().author.toLowerCase().includes(term.toLowerCase()) 
						||book.val().extra.toLowerCase().includes(term.toLowerCase())	
						||term == "")){
							addToTable(book.val());
					}
				});
			})
		}



		//----------------------------------------------------------------------------------------------------------------------------------
		// functions with indirect Firebasde acces
		//----------------------------------------------------------------------------------------------------------------------------------

		var globalKey;

		document.forms.addForm.onsubmit = function(e) {
			e = e || event;
			e.preventDefault();
		}
	

		document.getElementById('btnAddForm').addEventListener('click', function() {
			addBook();
		});
	
		function addBook() {
			// Get values
			let titel = document.getElementById("titel").value;
			let author = document.getElementById("author").value;
			let read = document.getElementById("checkRead").checked;
			let genre = document.getElementById("genreSelect").value;
			let score = document.getElementById("scoreIn").value;
			let extra = document.getElementById("extraTxt").value;
			let color = document.getElementById("colorSelect").value;

			if(color == "random color"){
				color = randomColor();
				// console.log(color)
			}
	
			writeBook(titel, author, read, genre, score, extra, color);
			document.getElementById('addForm').reset();
			clearBooks();
			readBooks();
		}

		document.getElementById('btnEditForm').addEventListener('click', function() {
			editBook();
		});

		function editBook() {
			showAddDiv("edit");
		}

		document.getElementById('btnSaveForm').addEventListener('click', function() {
			saveBook();
		});

		function saveBook() {
			// Get values
			let titel = document.getElementById("titel").value;
			let author = document.getElementById("author").value;
			let read = document.getElementById("checkRead").checked;
			let genre = document.getElementById("genreSelect").value;
			let score = document.getElementById("scoreIn").value;
			let extra = document.getElementById("extraTxt").value;
			let color = document.getElementById("colorSelect").value;

			if(globalKey == createKey(titel,author)){
				changeBook(globalKey, titel, author, read, genre, score, extra, color);
			} else {
				writeBook(titel, author, read, genre, score, extra, color);
				burnBook(globalKey);
			}
			document.getElementById('addForm').reset();
			document.getElementById("addDiv").style.display = "none";
			document.getElementById("boeken").style.display = "block";
			clearBooks();
			readBooks();
		}

		document.getElementById('removeBtn').addEventListener('click', function() {
			removeBook();
		});

		function removeBook() {
			document.getElementById("removeDiv").style.display = "block";
		}

		document.getElementById('burnBtn').addEventListener('click', function() {
			burnBook(globalKey);
			clearBooks();
			readBooks();
		});

		document.getElementById("searchField").addEventListener('keyup', function() {
			var genre =  document.getElementById("genreSelectFilter").value;
			var term = document.getElementById("searchField").value;
			clearBooks();
			filterBooksGenre(genre, term);
		})

		document.getElementById("genreSelectFilter").addEventListener('change', function() {
			var filter =  document.getElementById("genreSelectFilter").value;
			var term = document.getElementById("searchField").value;
			clearBooks();
			if(filter == "true" || filter == "false"){
				filterBooksRead(filter, term);
			} else if(!isNaN(filter)) {
				filterBooksScore(filter, term);
			}else {
				filterBooksGenre(filter, term);
			}
		})
		







		//----------------------------------------------------------------------------------------------------------------------------------
		// Extra functions
		//----------------------------------------------------------------------------------------------------------------------------------

		document.getElementById("addBtn").addEventListener('click', function(){
			showAddDiv('add');
		})

		function showAddDiv(key){
			if(key == "add"){
				document.getElementById("addDiv").style.display = "block";
				document.getElementById("btnAddForm").style.display = "block";
				document.getElementById("btnEditForm").style.display = "none";
				document.getElementById("btnSaveForm").style.display = "none";
				document.getElementById("removeBtn").style.display = "none";

				document.getElementById("titel").readOnly = false;
				document.getElementById("author").readOnly = false;
				document.getElementById("checkRead").disabled = false;
				document.getElementById("genreSelect").disabled = false;
				document.getElementById("scoreIn").readOnly = false;
				document.getElementById("extraTxt").readOnly = false;
				document.getElementById("colorSelect").disabled = false;

				document.getElementById("h3Form").innerHTML = "ADD A BOOK";
			} else if(key == "edit") {
				document.getElementById("btnAddForm").style.display = "none";
				document.getElementById("btnEditForm").style.display = "none";
				document.getElementById("btnSaveForm").style.display = "block";
				document.getElementById("addDiv").style.display = "block";

				document.getElementById("h3Form").innerHTML = "EDIT A BOOK";
				document.getElementById("removeBtn").style.display = "block";							
				document.getElementById("titel").readOnly = false;
				document.getElementById("author").readOnly = false;
				document.getElementById("checkRead").disabled = false;
				document.getElementById("genreSelect").disabled = false;
				document.getElementById("scoreIn").readOnly = false;
				document.getElementById("extraTxt").readOnly = false;
				document.getElementById("colorSelect").disabled = false;
			}
			else{
				globalKey = key.key;
				document.getElementById("addDiv").style.display = "block";
				document.getElementById("removeBtn").style.display = "block";

				document.getElementById("titel").value = key.titel;
				document.getElementById("author").value = key.author;
				document.getElementById("checkRead").checked = key.read;
				document.getElementById("genreSelect").value = key.genre;
				document.getElementById("scoreIn").value = key.score;
				document.getElementById("extraTxt").value = key.extra;
				document.getElementById("colorSelect").value = key.color;

				document.getElementById("titel").readOnly = true;
				document.getElementById("author").readOnly = true;
				document.getElementById("checkRead").disabled = true;
				document.getElementById("genreSelect").disabled = true;
				document.getElementById("scoreIn").readOnly = true;
				document.getElementById("extraTxt").readOnly = true;
				document.getElementById("colorSelect").disabled = true;

				document.getElementById("btnAddForm").style.display = "none";
				document.getElementById("btnEditForm").style.display = "block";
				document.getElementById("btnSaveForm").style.display = "none";
				document.getElementById("h3Form").innerHTML = "read A BOOK";
			}
		}
		

		function createKey(titel, author){
			return titel + "_" + author;
		}

		var cntr = 0;
		function addToTable(key){
			cntr++;

			var book = document.createElement("div");
			book.setAttribute("class","book");
			book.addEventListener('click',function(){
				showAddDiv(key)
			});
			var bgcolor = "background-color: " + key.color + ";";
			if(cntr == 1){
				bgcolor += "margin-top: 15px";
			}
			book.setAttribute("style",bgcolor);

			var spanTitel = document.createElement("span");
			spanTitel.setAttribute("class","titel");
			spanTitel.setAttribute("style","margin-top: 5px");
			spanTitel.appendChild(document.createTextNode(key.titel));

			var spanOpvulling = document.createElement("span");
			spanOpvulling.setAttribute("class","opvulling");
			spanOpvulling.setAttribute("style", "color: " + key.color + ";")
			// spanOpvulling.appendChild(document.createTextNode("___"));

			var spanAuthor = document.createElement("span");
			spanAuthor.setAttribute("class","author");
			spanAuthor.setAttribute("style","margin-bottom: 5px");
			spanAuthor.appendChild(document.createTextNode(key.author.split(" ").map(i => i.charAt(0)).join(".") + "."));
			

			book.appendChild(spanTitel);
			book.appendChild(spanOpvulling);
			book.appendChild(spanAuthor);
			document.getElementById("booklist").appendChild(book);


			if(cntr == 10){
				cntr = 0;
				var shelf = document.createElement("div");
				shelf.setAttribute("class","shelf");
				document.getElementById("booklist").appendChild(shelf);
			}
		}
		
		function addGenreSelect(genre) {
			var option = document.createElement("option");
			option.appendChild(document.createTextNode(genre));
			option.setAttribute("class","genreSelectOption");
			option.setAttribute("value", genre);
			document.getElementById("genreSelect").appendChild(option);
			
			option = document.createElement("option");
			option.appendChild(document.createTextNode(genre));
			option.setAttribute("class","genreSelectOption");
			option.setAttribute("value", genre);
			document.getElementById("genreSelectFilter").appendChild(option);
		}

		function addSelectFilter() {
			var read = document.createElement("option");
			read.appendChild(document.createTextNode("read"));
			read.setAttribute("class","genreSelectOption");
			read.setAttribute("value", true);
			document.getElementById("genreSelectFilter").appendChild(read);

			var unread = document.createElement("option");
			unread.appendChild(document.createTextNode("unread"));
			unread.setAttribute("class","genreSelectOption");
			unread.setAttribute("value", false);
			document.getElementById("genreSelectFilter").appendChild(unread);

			for(var i=5; i>=0; i--) {
				addSelectFilterScore(i);
			}
		}

		function addSelectFilterScore(intScore) {
			var score = document.createElement("option");
			score.appendChild(document.createTextNode(intScore + "/5"));
			score.setAttribute("class","genreSelectOption");
			score.setAttribute("value", intScore);
			document.getElementById("genreSelectFilter").appendChild(score);
		}

		function addColorSelect(color) {
			var option = document.createElement("option");
			option.appendChild(document.createTextNode(color.name));
			option.setAttribute("class","colorSelectOption");
			option.setAttribute("value", color.color);
			document.getElementById("colorSelect").appendChild(option);
		}

		document.getElementById("backAddBtn").addEventListener('click', function() {
			backAdd();
		})

		function backAdd(){
			document.getElementById("addDiv").style.display = "none";
			document.getElementById("removeDiv").style.display = "none";

			document.getElementById("titel").value = "";
			document.getElementById("author").value = "";
			document.getElementById("scoreIn").value = "";
			document.getElementById("checkRead").checked = false;
			document.getElementById("genreSelect").value = "no genre";
			document.getElementById("scoreIn").value = "";
			document.getElementById("extraTxt").value = "";
			document.getElementById("colorSelect").value = "random color";
		}

		document.getElementById("removeBurnBtn").addEventListener('click', function() {
			removeBurnDiv();
		})

		function removeBurnDiv() {
			document.getElementById("removeDiv").style.display = "none";
		}

		function clearBooks() {
			// console.log("clearing");
			backAdd();
			document.getElementById("booklist").remove(); 

			var booklist = document.createElement("div");
			booklist.setAttribute("id", "booklist");
			document.getElementById("boeken").append(booklist);
			// readBooks();
		}

		document.getElementById("scoreIn").addEventListener('keyup', function(){limit(this)})
		function limit(element) {
			var max_chars = 1;
				
			if(element.value.length > max_chars) {
				element.value = element.value.substr(0, max_chars);
			}
		}
	</script>

</body>
</html>
